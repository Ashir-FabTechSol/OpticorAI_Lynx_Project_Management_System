{% extends 'core/base.html' %}
{% load static %}
{% load score_tags %}

{% block breadcrumb %}
    <li class="breadcrumb-item">Settings</li>
    <li class="breadcrumb-item active">Employee Progress</li>
{% endblock breadcrumb %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-md-flex justify-content-between align-items-center">
          <div>
            <h4><i class="fa fa-chart-bar"></i> Employee Progress Management</h4>
            <p class="text-muted">Calculate and view employee progress based on KPI performance</p>
          </div>
          <div class="mt-2 mt-md-0">
            <a href="{% url 'core:kpi-list' %}" class="btn btn-outline-primary">
              <i class="fa fa-cog"></i> Manage KPIs
            </a>
          </div>
        </div>
        <div class="card-body">
          
          <!-- KPI Weight Summary -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">KPI Weight Summary</h6>
                  <div class="row">
                    <div class="col-6">
                      <strong>Total Weight:</strong> {{ total_kpi_weight }}%
                    </div>
                    <div class="col-6">
                      <strong>Available:</strong> {{ available_weight }}%
                    </div>
                  </div>
                  <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar" role="progressbar"
                         data-width="{{ total_kpi_weight|default:0 }}"
                         style="width: 0%"
                         aria-valuenow="{{ total_kpi_weight }}"
                         aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  {% if total_kpi_weight < 100 %}
                    <small class="text-muted">Add more KPIs to reach 100% weight distribution</small>
                  {% elif total_kpi_weight == 100 %}
                    <small class="text-success">Perfect! All KPI weights are distributed (100%)</small>
                  {% else %}
                    <small class="text-danger">Total weight exceeds 100% - please adjust KPI weights</small>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <h6 class="card-title">Progress Formula</h6>
                  <p class="card-text small">
                    Employee Progress Score = (Average Project KPI Score × Project KPI Weight) + 
                    (Average HSE KPI Score × HSE KPI Weight) + (… more if needed)
                  </p>
                  <p class="card-text small mb-0">
                    <strong>Note:</strong> Total KPI weights must equal 100%
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Employee Selection Form -->
          <form method="get" class="row g-2 align-items-end mb-4">
            <div class="col-md-4">
              <label for="employee">Employee:</label>
              <select name="employee" id="employee" class="form-control">
                <option value="">-- Select Employee --</option>
                {% for emp in subordinates %}
                  <option value="{{ emp.id }}" {% if emp.id|stringformat:'s' == selected_employee.id|stringformat:'s' %}selected{% endif %}>{{ emp.get_full_name }}</option>
                {% endfor %}
              </select>
            </div>
             <div class="col-md-3">
               <label for="period_start">Start Date:</label>
               <input type="date" name="period_start" id="period_start" class="form-control" value="{{ period_start|default:'' }}">
             </div>
             <div class="col-md-3">
               <label for="period_end">End Date:</label>
               <input type="date" name="period_end" id="period_end" class="form-control" value="{{ period_end|default:'' }}">
             </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fa fa-search"></i> Calculate
              </button>
            </div>
          </form>

          <!-- Progress Results -->
          {% if progress_records %}
            {% for progress_record in progress_records %}
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">
                    <i class="fa fa-user"></i> 
                    {{ progress_record.employee.get_full_name }} - Progress Report
                    <span class="badge badge-{{ progress_record.total_progress_score|score_to_badge }} float-right">
                      {{ progress_record.total_progress_score }}%
                    </span>
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Progress Summary</h6>
                      <table class="table table-sm">
                        <tr>
                          <td><strong>Period:</strong></td>
                          <td>{{ progress_record.period_start }} to {{ progress_record.period_end }}</td>
                        </tr>
                        <tr>
                          <td><strong>Total Score:</strong></td>
                          <td>
                            <span class="badge badge-{% if progress_record.total_progress_score >= 80 %}success{% elif progress_record.total_progress_score >= 60 %}warning{% else %}danger{% endif %}">
                              {{ progress_record.total_progress_score }}%
                            </span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Calculated:</strong></td>
                          <td>{{ progress_record.calculation_date|date:"M d, Y H:i" }}</td>
                        </tr>
                      </table>
                    </div>
                    <div class="col-md-6">
                      <h6>KPI Breakdown</h6>
                      {% if progress_record.progress_breakdown %}
                        {% for kpi_name, kpi_data in progress_record.progress_breakdown.items %}
                          <div class="mb-2">
                            <div class="d-flex justify-content-between">
                              <span>{{ kpi_name }} ({{ kpi_data.weight }}%)</span>
                            <span class="badge badge-{{ kpi_data.average_score|score_to_badge }}">
                                {{ kpi_data.average_score }}%
                              </span>
                            </div>
                            <div class="progress" style="height: 6px;">
                              <div class="progress-bar" role="progressbar"
                                   data-width="{{ kpi_data.average_score|default:0 }}"
                                   style="width: 0%"
                                   aria-valuenow="{{ kpi_data.average_score }}"
                                   aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">{{ kpi_data.task_count }} tasks</small>
                          </div>
                        {% endfor %}
                      {% else %}
                        <p class="text-muted">No KPI data available</p>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="mt-3">
                   <a href="{% url 'core:employee-progress-detail' progress_record.employee.id %}?period_start={{ safe_period_start|default:period_start }}&period_end={{ safe_period_end|default:period_end }}" 
                       class="btn btn-outline-primary btn-sm">
                      <i class="fa fa-eye"></i> View Details
                    </a>
                     <form method="post" action="{% url 'core:recalculate-progress' progress_record.employee.id %}" class="d-inline">
                      {% csrf_token %}
                       <input type="hidden" name="period_start" value="{{ safe_period_start|default:period_start }}">
                       <input type="hidden" name="period_end" value="{{ safe_period_end|default:period_end }}">
                       <button type="submit" class="btn btn-outline-warning btn-sm">
                        <i class="fa fa-refresh"></i> Recalculate
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% elif selected_employee %}
            <div class="alert alert-info">
              <i class="fa fa-info-circle"></i> No progress data available for the selected period. 
              Make sure the employee has completed tasks with evaluations in this timeframe.
            </div>
          {% endif %}

          {% if tasks_in_period %}
          <hr>
          <h5 class="mt-3">Task Details (Selected Period)</h5>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Task</th>
                  <th>KPI</th>
                  <th>Priority</th>
                  <th>Final Score</th>
                  <th>Completion Date</th>
                </tr>
              </thead>
              <tbody>
                {% for t in tasks_in_period %}
                <tr>
                  <td class="text-wrap">{{ t.issue_action }}</td>
                  <td>{% if t.kpi %}{{ t.kpi.name }}{% else %}-{% endif %}</td>
                  <td>{% if t.priority %}{{ t.priority.name }}{% else %}-{% endif %}</td>
                  <td><span class="badge badge-{{ t.final_score|score_to_badge }}">{{ t.final_score|default:0 }}%</span></td>
                  <td>{{ t.completion_date|date:"M d, Y" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <h5 class="mt-4">Scores by KPI</h5>
          <div class="chart-wrapper" style="height: 320px;">
            <canvas id="scoresByKPIChart"></canvas>
          </div>
          {{ tasks_in_period_json|json_script:"tasksPeriodData" }}
          {% endif %}
          
        </div>
      </div>
    </div>
  </div>
</div>
<script src="{% static 'vendor/chart.js' %}" defer></script>
<script src="{% static 'vendor/chartjs-plugin-datalabels.js' %}" defer></script>
<script src="{% static 'js/employee_progress_list.js' %}" defer></script>
{% endblock %}
